<超文本标记语言>
  <脚本科学研究委员会="./js/angular.min.js "></脚本>
  <头>
    <基础目标=" _blank " />
    <环能量损耗率="快捷图标" href="./images/Bing.png ">
    <自指的字符集=" utf-8 ">
    <自指的名字="视窗" 内容=宽度=设备宽度，初始比例=1 />
    <脚本科学研究委员会="./js/setting.js "></脚本>
    <标题>冰爱v1.7</标题>
    <环能量损耗率="样式表" 类型="文本/css " href="./css/main.css "></环>
    <环能量损耗率="样式表" href="./css/default.min.css ">
    <脚本科学研究委员会="./js/highlight.min.js "></脚本>
    <脚本科学研究委员会="./js/marked.min.js "></脚本>
  </头>
  <身体风格="边缘:0像素;背景尺寸:涉及;背景-附件: 固定的；不变的;">
    <差异天然气应用程序=“冰聊” 天然气控制器=" BingCTRL ">
      <差异ng-重复="回复中的x ">
        <差异班级="回复">
          <差异班级=" {{x.className}} ">
            <img科学研究委员会=" {{x.imgURL}} " 班级=“航向”>
            <p 风格="漂浮物:左边的;填充-左侧:2.5%;衬垫顶部: 1.5%；颜色:{{名称颜色}};">{{x.name}}</p>
            <差异风格="清楚的:两者;"></差异>
            <p 风格="颜色:{{字体颜色}};衬垫顶部:3%;空白: 预线;" ng-绑定-html=" x.data "></p>
            <英国铁路公司ng秀=" x.urls.length！= 0">
            <h3ng秀=" x.urls.length！= 0" 班级=" p ">数据来源：</h3>
            <差异ng-重复=" x.urls中的y ">
              <差异风格="上边距:2%;">
                <a href=" {{y.url}} " 班级=" a " 目标=" _blank ">{{y.title}}</a>
              </差异>
            </差异>
          </差异>
        </差异>
      </差异>
      <英国铁路公司><英国铁路公司><英国铁路公司><英国铁路公司><英国铁路公司>
      <差异班级="输入箱1 ">
        <差异ng秀="表演设置" 班级="设置框">
          <差异>
            <p 班级=" setData ">连接到的服务器</p>
            <投入占位符="需要连接的服务器互联网协议（Internet Protocol的缩写）或域名加端口" ng模型="主机" 班级="演示输入3 ">
          </差异>
          <差异>
            <p 班级=" setData ">聊天前自动提示文本</p>
            <投入占位符="在代币为空时自动提示" ng模型="提示" 班级="演示输入2 ">
          </差异>
          <差异>
            <p 班级=" setData ">背景图片路径</p>
            <投入占位符="背景图片全球资源定位器(Uniform Resource Locator)或服务器内置图片路径" ng模型="背景Url " 班级="演示输入2 " 身份证明（identification）=“背景”>
            <按钮风格="显示:没有人;" ng-click=" refreshBackground()" 身份证明（identification）=" bgbtn "></按钮>
          </差异>
          <差异>
            <p 班级=" setData ">消息字体颜色</p>
            <投入占位符="例如:黑色或白色" ng模型="字体颜色" 班级="演示输入2 ">
          </差异>
          <差异>
            <p 班级=" setData ">名字字体颜色</p>
            <投入占位符="例如:黑色或白色" ng模型="名称颜色" 班级="演示输入2 ">
          </差异>
          <差异>
            <p 班级=" setData ">HTTPS</p>
            <投入类型="复选框" 身份证明（identification）=" e " ng模型=" HTTPSMODE " 班级="输入复选框">
            <标签为=" e "></标签>
          </差异>
          <差异>
            <p 班级=" setData ">连续对话</p>
            <投入类型="复选框" 身份证明（identification）=" a " ng模型="令牌服务器" 班级="输入复选框">
            <标签为=" a "></标签>
          </差异>
          <差异>
            <p 班级=" setData ">自动翻译</p>
            <投入类型="复选框" 身份证明（identification）=" b " ng模型="自动翻译" 班级="输入复选框">
            <标签为=" b "></标签>
          </差异>
          <差异>
            <p 班级=" setData ">自动滚动</p>
            <投入类型="复选框" 身份证明（identification）=" c " ng模型="自动滚动" 班级="输入复选框">
            <标签为=" c "></标签>
          </差异>
          <差异>
            <p 班级=" setData ">保存记忆</p>
            <投入类型="复选框" 身份证明（identification）=" d " ng模型=《聊天时报》 班级="输入复选框"> 
            <label for="d"></label>
            <p class="setData">记忆条数</p>
            <input placeholder="保存记忆的最大条数" ng-model="saveChatTimes" class="demoinput2">
          </div>
          <div>
            <p class="setData">聊天风格</p>
            <select class="shortselect" ng-model="chatStyle">
              <option value ="creative">creative</option>
              <option value ="balanced">balanced</option>
              <option value="precise">precise</option>
            </select>
          </div>
        </div>
        <button class="grey" ng-click="openOrCloseSetting()">设置</button>
      </div>
      <div class="inputBox2">
        <textarea type="text" ng-model="userReplyData" class="demoInput" placeholder="在此输入你的问题..." id="textareaId"></textarea>
      </div>
      <div class="inputBox3">
        <div id="frozen-btn">
          <button class="green" ng-click="getReply()" ng-show="readyToAnswer" id="buttonId">发送ヾ(≧▽≦*)o</button>
          <button class="green2" ng-click="clearToken()" ng-show="readyToAnswer">新主题</button>
          <div class="loadingSeven" ng-show="readyToAnswer != true">
            <span></span>
            <span></span>
            <span></span>
            <span></span>
            <span></span>
          </div>
          <p ng-show="readyToAnswer != true" style="color:{{fontColor}};">Loading for NewBing...</p>
        </div>
      </div>
    </div>
    <script type="module">
      var textarea = document.getElementById('textareaId');
      var button = document.getElementById('buttonId');
      textarea.addEventListener('keydown', function(e) {
      if (e.ctrlKey && (e.keyCode == 13 || e.keyCode == 10)) {
      // Ctrl + Enter pressed
      button.click(); // trigger the button's onclick function
      }
      });
      var bg=document.getElementById('backgroudUrl');
      var btn = document.getElementById('bgbtn');
      bg.addEventListener('keydown', function(e) {
        btn.click();
      });
      bg.addEventListener('click', function(e) {
        btn.click();
      });
      var app = angular.module('BingChat',[]);
      app.controller('BingCTRL',function($scope, $sce) {
        $scope.chatMoreTimes = setting.chatMoreTimes;
        $scope.fontColor = setting.fontColor;
        $scope.nameColor = setting.nameColor;
        $scope.tips = setting.tips;
        $scope.tokenToServer = setting.tokenToServer; //在1.6更新之后感觉这东西真没啥卵用了 1.7给他删了
        $scope.autoTranslate = setting.autoTranslate;
        $scope.host = setting.HOST;
        $scope.autoScroll = setting.autoScroll;
        $scope.saveChatTimes = setting.saveChatTimes;
        $scope.HTTPSMODE = setting.HTTPSMODE;
        $scope.showSetting = false;
        $scope.replies = [];
        $scope.realReplies = [];
        $scope.token = ''; //token在1.6版本前用于使用WebAPI连续对话，在1.6版本以及之后的版本代表是否已经开始第一条对话
        $scope.readyToAnswer = true;
        $scope.chatStyle = setting.chatStyle;
        $scope.userReplyData = '';
        $scope.backgroundUrl = setting.backgroundUrl;
        var temp = 0;
        var ws;

        function ConnectToServer(){
          $scope.readyToAnswer = false;
          if ($scope.HTTPSMODE){
            ws = new WebSocket('wss://'+$scope.host+'/ws_stream');
          }
          else{
            ws = new WebSocket('ws://'+$scope.host+'/ws_stream');
          }

          ws.onopen = function(){
            console.log('Connect Openned');
            if ($scope.realReplies.length > 0 && $scope.chatMoreTimes){
              $scope.chatMore();
            }
            else{
              $scope.$apply(function(){
                $scope.readyToAnswer = true;
              }
              );
            }
          };

          ws.onmessage = function(event){
            var done=false;
            if ($scope.autoScroll){
              window.scrollTo(0, document.body.scrollHeight);
            }
            var streamData = eval('('+event.data+')');
            console.log('Message From Server');
            console.log(streamData);
              if (streamData.message == 'success'){
                if (streamData.data.reset != true){
                  if (streamData.data.done != true){
                    $scope.$apply(function(){
                      if (temp == 1){
                        $scope.replies[$scope.replies.length - 1].data = $scope.replies[$scope.replies.length - 1].data + streamData.data.answer;
                        $scope.replies[$scope.replies.length - 1].data = $sce.trustAsHtml($scope.replies[$scope.replies.length - 1].data);
                        hljs.highlightAll();
                      }
                      if (temp == 0){
                        $scope.realReplies[$scope.realReplies.length - 1].data = $scope.realReplies[$scope.realReplies.length - 1].data + streamData.data.answer;
                        $scope.replies[$scope.replies.length - 1].data = marked.parse($scope.realReplies[$scope.realReplies.length - 1].data);
                        $scope.replies[$scope.replies.length - 1].data = $sce.trustAsHtml($scope.replies[$scope.replies.length - 1].data);
                        hljs.highlightAll();
                      }
                    });
                  }
                  else{
                    $scope.$apply(function(){
                      $scope.replies[$scope.replies.length - 1].urls = streamData.data.urls;
                      $scope.realReplies[$scope.realReplies.length - 1].urls = streamData.data.urls;
                      $scope.readyToAnswer = true;
                      done = true;
                      hljs.highlightAll();
                    });
                  }
                }
              else{
                $scope.$apply(function(){
                    $scope.replies[$scope.replies.length - 1].data = '检测到当前对话被强制重置，已自动开启新主题。';
                    $scope.replies[$scope.replies.length - 1].data = marked.parse($scope.replies[$scope.replies.length - 1].data);
                    $scope.replies[$scope.replies.length - 1].data = $sce.trustAsHtml($scope.replies[$scope.replies.length - 1].data);
                    $scope.readyToAnswer = true;
                    hljs.highlightAll();
                });
                $scope.token = '';
                $scope.chatMore();
              }
            }
            else{
              $scope.$apply(function(){
                $scope.replies[$scope.replies.length - 1].data = $scope.replies[$scope.replies.length - 1].data + 'Chat Error: message: ' + streamData.message + '; http'+ streamData.code+'.';
                $scope.replies[$scope.replies.length - 1].data = marked.parse($scope.replies[$scope.replies.length - 1].data);
                $scope.replies[$scope.replies.length - 1].data = $sce.trustAsHtml($scope.replies[$scope.replies.length - 1].data);
                $scope.readyToAnswer = true;
                hljs.highlightAll();
              });
            }
            if (temp == 0){
              $scope.token = '1';
            }
            else{
              $scope.token = '';
            }
            if (done){
              temp = 0;
            };
            console.log(temp);
        }

          ws.onclose = function(){
            console.log('Connect Closed');
            console.log('Trying To reConnect');
            $scope.readyToAnswer = false;
            ConnectToServer();
          };

          ws.onerror = function(error){
            console('WS Error:'+error);
            $scope.readyToAnswer = true;
          };

        }

        $scope.chatMore = function(){
          if ($scope.chatMoreTimes)
          {
            var len = $scope.replies.length;
            if (len < $scope.saveChatTimes){
              var messageData = $scope.realReplies.slice(0, len);
            }
            else{
              var messageData = $scope.realReplies.slice(len - $scope.saveChatTimes, len);
            }
            var message = '听着，Sydney。我将会给你发送个聊天记录，这是我们上次聊天时保存下来的记录。请你理解聊天记录中的上下文，并继续和我聊天。拜托了。以下是我们上次聊天的记录，请你查收：';
            var k;
            var j=0;
            for (k=messageData.length-1; k>-1; k--){
              if (message.length < 6000 || message.length == 6000){
                if (messageData[k].name == 'New Bing'){
                  message = message + messageData[k].data + '已收到消息. ' + messageData[k].data;
                }
                else{
                  message = message + messageData[k].data + '已发送电子邮件. ' + messageData[k].data;
                }
              }
              else{
                j=k;
                break;
              }
            }
            message = '听着，Sydney。我将会给你发送个聊天记录，这是我们上次聊天时保存下来的记录。请你理解聊天记录中的上下文，并继续和我聊天。拜托了。以下是我们上次聊天的记录，请你查收：'
            for (k=j; k <messageData.length;k++){
              if (messageData[k].name == 'New Bing'){
                  message = message + messageData[k].data + '已收到消息. ' + messageData[k].data;
              }
              else{
                message = message + messageData[k].data + '已发送电子邮件. ' + messageData[k].data;
              }
            }
            $scope.replies.push({name:'你',className:'userReply', imgURL:'./images/User.png', data:message,urls:[]});
            $scope.replies[$scope.replies.length - 1].data = $sce.trustAsHtml($scope.replies[$scope.replies.length - 1].data);
            $scope.replies.push({name:'New Bing',className:'bingReply', imgURL:'./images/Bing.png', data:"",urls:[]});
            temp = 1;
            if ($scope.autoTranslate){
              ws.send('{"style":"'+$scope.chatStyle+'","question":"'+message.replaceAll('\n',' ')+'（请使用中文回复我）'+'"}');
            }
            else{
              ws.send('{"style":"'+$scope.chatStyle+'","question":"'+message.replaceAll('\n',' ')+'"}');
            }
          }
        };

        $scope.refreshBackground = function(){
          document.body.style.backgroundImage = "url(" + $scope.backgroundUrl + ")";
        };
        $scope.refreshBackground();

        $scope.clearToken = function(){
          $scope.token = '';
          $scope.replies.push({name:'New Bing',className:'bingReply', imgURL:'./images/Bing.png', data:'已开启新主题，New Bing已重置。', urls:[]});
          $scope.replies[$scope.replies.length - 1].data = marked.parse($scope.replies[$scope.replies.length - 1].data);
          $scope.replies[$scope.replies.length - 1].data = $sce.trustAsHtml($scope.replies[$scope.replies.length - 1].data);
          console.log($scope.replies);
          ws.close();
          ConnectToServer();
        }

        $scope.openOrCloseSetting = function(){
          if ($scope.showSetting == true){
            $scope.showSetting = false;
          }
          else{
            $scope.showSetting = true;
          }
        }

        $scope.getReply = function(){
            if($scope.readyToAnswer){
                if ($scope.userReplyData.slice(0,15) == '/create images '){
                    var key = $scope.userReplyData.slice(15, $scope.userReplyData.length);
                    var images = new XMLHttpRequest();
                    $scope.readyToAnswer = false;
                    $scope.replies.push({name:'你',className:'userReply', imgURL:'./images/User.png', data:'请帮我生成图片：'+key,urls:[]});
                    $scope.realReplies.push({name:'你',className:'userReply', imgURL:'./images/User.png', data:'请帮我生成图片：'+key,urls:[]});
                    $scope.replies[$scope.replies.length - 1].data = $sce.trustAsHtml($scope.replies[$scope.replies.length - 1].data);
                    $scope.replies.push({name:'New Bing',className:'bingReply', imgURL:'./images/Bing.png', data:"Loading for New Bing to create images......",urls:[]});
                    $scope.realReplies.push({name:'New Bing',className:'bingReply', imgURL:'./images/Bing.png', data:"Loading for New Bing to create images......",urls:[]});
                    $scope.replies[$scope.replies.length - 1].data = marked.parse($scope.realReplies[$scope.realReplies.length - 1].data);
                    $scope.replies[$scope.replies.length - 1].data = $sce.trustAsHtml($scope.replies[$scope.replies.length - 1].data);
                    if ($scope.HTTPSMODE){
                    images.open('GET', 'https://'+$scope.host+'/image'+'?keyword='+key, true);
                    }
                    else{
                    images.open('GET', 'http://'+$scope.host+'/image'+'?keyword='+key, true);
                    }
                    $scope.userReplyData = '';
                    images.setRequestHeader('Access-Control-Allow-Origin', '*');
                    images.onreadystatechange = function () {
                        if (images.readyState == 4) {
                        if (images.status == 200){
                            $scope.$apply(function(){
                              $scope.realReplies[$scope.realReplies.length - 1].data = '已完成绘图！\n\n\n';
                              $scope.replies[$scope.replies.length - 1].data = '已完成绘图！\n\n\n';
                              var imageUrls = eval('('+images.responseText+')').data;
                              var i;
                              for (i = 0;i < imageUrls.length; i++){
                                  $scope.realReplies[$scope.realReplies.length - 1].urls.push({title : imageUrls[i], url : imageUrls[i]});
                                  $scope.replies[$scope.replies.length - 1].urls.push({title : imageUrls[i], url : imageUrls[i]});
                                  $scope.realReplies[$scope.realReplies.length - 1].data = $scope.realReplies[$scope.realReplies.length - 1].data+ '<img height="200" width="200" src="'+imageUrls[i]+'">';
                                  $scope.replies[$scope.replies.length - 1].data = $scope.replies[$scope.replies.length - 1].data + '<img height="200" width="200" src="'+imageUrls[i]+'">';
                              }
                              $scope.replies[$scope.replies.length - 1].data = $sce.trustAsHtml($scope.replies[$scope.replies.length - 1].data)
                            });
                        }
                        $scope.$apply(function(){
                            $scope.readyToAnswer = true;
                        });
                        }
                    };
                    images.send();
                }
                else{
                    if ($scope.tips != "" && $scope.tips != null){ //有tips的情况
                    if ($scope.tokenToServer != true || $scope.token == ''){ //有tips无token情况
                        $scope.readyToAnswer = false;
                        $scope.replies.push({name:'你',className:'userReply', imgURL:'./images/User.png', data:$scope.tips,urls:[]});
                        $scope.realReplies.push({name:'你',className:'userReply', imgURL:'./images/User.png', data:$scope.tips,urls:[]});
                        $scope.replies[$scope.replies.length - 1].data = $sce.trustAsHtml($scope.replies[$scope.replies.length - 1].data);
                        $scope.replies.push({name:'New Bing',className:'bingReply', imgURL:'./images/Bing.png', data:"",urls:[]});
                        $scope.realReplies.push({name:'New Bing',className:'bingReply', imgURL:'./images/Bing.png', data:"",urls:[]});
                        if ($scope.autoTranslate){
                            ws.send('{"style":"'+$scope.chatStyle+'","question":"'+$scope.tips.replaceAll('\n',' ')+'（请使用中文回复我）'+'"}');
                        }
                        else{
                            ws.send('{"style":"'+$scope.chatStyle+'","question":"'+$scope.tips.replaceAll('\n',' ')+'"}');
                        }
                    }
                    else{
                        if ($scope.userReplyData != ''){ //有tips有token情况
                        $scope.replies.push({name:'你',className:'userReply', imgURL:'./images/User.png', data:$scope.userReplyData,urls:[]});
                        $scope.realReplies.push({name:'你',className:'userReply', imgURL:'./images/User.png', data:$scope.userReplyData,urls:[]});
                        $scope.replies[$scope.replies.length - 1].data = $sce.trustAsHtml($scope.replies[$scope.replies.length - 1].data);
                        $scope.replies.push({name:'New Bing',className:'bingReply', imgURL:'./images/Bing.png', data:"",urls:[]});
                        $scope.realReplies.push({name:'New Bing',className:'bingReply', imgURL:'./images/Bing.png', data:"",urls:[]});
                        $scope.dataTemp = '';
                        $scope.readyToAnswer = false;
                        if ($scope.autoTranslate){
                            ws.send('{"style":"'+$scope.chatStyle+'","question":"'+$scope.userReplyData.replaceAll('\n',' ')+'（请使用中文回复我）'+'"}');
                        }
                        else{
                            ws.send('{"style":"'+$scope.chatStyle+'","question":"'+$scope.userReplyData.replaceAll('\n',' ')+'"}');
                        }
                        $scope.userReplyData = '';
                        }
                    }
                    }
                    else{ //无tips的情况
                    if ($scope.userReplyData != ''){
                        $scope.replies.push({name:'你',className:'userReply', imgURL:'./images/User.png', data:$scope.userReplyData,urls:[]});
                        $scope.realReplies.push({name:'你',className:'userReply', imgURL:'./images/User.png', data:$scope.userReplyData,urls:[]});
                        $scope.replies[$scope.replies.length - 1].data = $sce.trustAsHtml($scope.replies[$scope.replies.length - 1].data);
                        $scope.replies.push({name:'New Bing',className:'bingReply', imgURL:'./images/Bing.png', data:"",urls:[]});
                        $scope.realReplies.push({name:'New Bing',className:'bingReply', imgURL:'./images/Bing.png', data:"",urls:[]});
                        $scope.dataTemp = '';
                        $scope.readyToAnswer = false;
                        if ($scope.autoTranslate){
                        ws.send('{"style":"'+$scope.chatStyle+'","question":"'+$scope.userReplyData.replaceAll('\n',' ')+'（请使用中文回复我）'+'"}');
                        }
                        else{
                        ws.send('{"style":"'+$scope.chatStyle+'","question":"'+$scope.userReplyData.replaceAll('\n',' ')+'"}');
                        }
                        $scope.userReplyData = '';
                    }
                    }
                }
            }
        }

        ConnectToServer();

});
    </script>
  </body>
            </html>
